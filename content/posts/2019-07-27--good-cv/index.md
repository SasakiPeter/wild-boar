---
title: 良いバリデーションとは？
category: "data-science"
cover: analysis.jpg
author: sasaki peter
---

バリデーションとは、モデルの性能を評価することである。
機械学習のモデルは、未知のデータに対する予測性能が高い程、いいモデルとされる。
真に未知のデータへの予測性能は誰も分からないため、サロゲートなエンドポイントとして、自分で未知っぽいデータを作成して、それに対する予測性能から未知のデータに対する性能を評価する。

そこには、暗黙的に自分で作成した未知っぽいデータへの予測性能と、本当に未知であるデータに対する予測性能が相関しているという前提が存在する。

しかし、実際には、これが相関している状況を作り出すのはかなり難しい。

これが相関しないような状況はどういう時が考えられるかというと、作成した未知っぽいデータに対する過学習があげられる。この場合、自分で作成した未知っぽいデータに対する予測性能が高ければ高いほど、真に未知のデータに対する予測性能は下がるということが起こりうる。

そのため、この真に未知のデータに対する予測性能を評価するためには、真に未知のデータの分布と同じような未知っぽいデータの作成や、自分で作成した未知っぽいデータに対する過学習を防ぐようなバリデーションのスキームを考える必要がある。

この自分で作成した未知っぽいデータを一般的にバリデーションのためのデータセットということでバリデーションセットと呼ぶ。最初に全てのデータをトレーニングセットとバリデーションセットに分け、トレーニングセットを用いて、モデルを作成したのち、バリデーションへの予測性能から、真の未知のデータに対する予測性能を評価する。真の未知のデータに対する予測性能は汎化性能というので、今後は汎化性能という。

この最初にトレーニングセット（学習セット）とバリデーションセット（検証セット）に分割して、性能を評価する方法をホールドアウト法というが、このホールドアウト法を一度行うだけでは、使用したバリデーションセットへの性能だけしか評価できないため、何度も調整を繰り返すうちにバリデーションセットにオーバーフィット（過学習、過適合）してしまい、汎化性能は下がる。

そこで交差検証（クロスバリデーション、CV）を行うのが一般的となっている。
データセットを５分割し、１つを学習セットとし、残りを検証セットとするのをローテーションして行い、５つのモデルを作成し、検証セットで評価を行う。そして、それぞれの予測性能を平均したものをこのモデル群の予測性能とする。
この場合、5つのモデルが作成されるため、未知のデータを予測する時はどうすればいいのかという疑問が生じる。

ひとつの方法は、学習セットと検証セット両方を用いてひとつのモデルを作成し、その予測性能は上記のCVの平均だとする方法である。

２つ目の方法は、５つのモデルの予測結果を統合し、ひとつの予測結果とする方法である。こちらの方が安定感があって、オーバーフィットしにくい予測ができるらしい。

実際に試してみると、どちらの方が良いかはケースバイケースで、個人的にはどちらがいいという結論は出ていない。

５つのモデルのアンサンブルを行うということだが、回帰モデルのときは簡単で、単純に予測結果の平均を取ればいいが、分類の場合はそうはいかない。それは、分類のprobabilityは相対評価であることが原因である。
したがって以下のような手順を踏むことが望ましそうである。

* CVして５つのモデルができました。（average of AUC=0.80みたいな）
* そのCVに用いたデータ全てをそれぞれのモデルに予測させます。
* ５つのpredictionが得られます。
* それぞれのpredictionをrankづけ(1から順に番号を振る)したのち、平均してひとつのpredictionにします。
* これが学習セットの予測結果です。AUCが出せます。ついでに、カットオフ値も決めます。
* 先のAUCと今回のAUCの比較をしてみたいです。
* ここまでで、モデルの作成は終了です。
* 次にテストセットの予測を行います。
* テストセットを５つそれぞれのmodelで予測します。
* 得られたpredictionをどうやってランク付けして統合するんですか？
* バリデーションの近い値を覚えていて、それのrankを平均化して、predictionをする
* predictionをカットオフで切って予測ラベルとする

という手順で、実装がかなり面倒そうという印象。

上の内容を例え話にするとこうなる。

過去問をめっちゃ勉強して、100%学習したとしても、本番のテストでは60点かもしれない。逆に、過去問はほどほど(80% くらい)に、傾向をうまく掴んで勉強した場合は、本番のテストで80点取れるかもしれない。このように、いくら真面目に学習したところで、その学習内容に特化しすぎてしまうと、未知の問題に対する能力が発揮されないことがある

これを過学習といい、未知のデータに対する能力を汎化性能という。

すなわち、学習においてもっとも大切なのは、未知のデータに対する能力であり、それを計測するためにバリデーションを行うことが大事。バリデーションとは妥当性を評価すること。

いくら学習データをよく学べたとしても汎化性能があるとは言えないので、未知のデータっぽいものを用意しておいて、それに対する性能を評価することで、より汎化性能を正確に評価できる。

しかし、これも穴があって、そのバリデーションに過学習してしまう可能性がある。

授業の内容をしっかり勉強して、実力を図ろうといざ過去問を解いてみると、思いの外、問題がわからない。そんな時、そのわからなかった問題や、その範囲を重点的に勉強するのではなかろうか。
そうした結果、その過去問の出題形式なら問題なく解けるようになったが、いざ本番の試験では、大きく問題傾向が変わってしまって解けなくなってしまうということがありうる。

これを防ぐために、本当に正確に汎化性能が測れるバリデーションはどのように行えばいいか、というのがとても大事なのである。
